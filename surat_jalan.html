<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surat Jalan KSE v3</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* Merapikan kolom isian agar titik dua sejajar */
        .input-group { display: flex; align-items: center; margin-bottom: 10px; }
        .input-group label { width: 150px; font-weight: bold; display: flex; justify-content: space-between; }
        .input-group label::after { content: ":"; margin-right: 10px; }
        .input-group input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }

        .button-group { margin-top: 20px; display: flex; gap: 10px; }
        button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 4px; color: white; }
        .btn-save { background-color: #28a745; }
        .btn-pdf { background-color: #007bff; }
        .btn-reset { background-color: #dc3545; }

        /* Area Cetak / Preview */
        #surat-jalan-render { margin-top: 30px; padding: 20px; border: 1px solid #000; background: white; min-height: 400px; }
        .preview-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .preview-content b { font-weight: bold; }
        #qrcode { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Input Data Surat Jalan</h2>
    
    <div class="input-group">
        <label>Nomor SJ</label>
        <input type="text" id="in_nosj" class="kse-input" placeholder="Masukkan No SJ">
    </div>
    <div class="input-group">
        <label>Tujuan / PT</label>
        <input type="text" id="in_pt" class="kse-input" placeholder="Nama Perusahaan">
    </div>
    <div class="input-group">
        <label>Quantity</label>
        <input type="text" id="in_qty" class="kse-input" placeholder="Jumlah Barang">
    </div>
    <div class="input-group">
        <label>Nomor Polisi</label>
        <input type="text" id="in_nopol" class="kse-input" placeholder="B 1234 ABC">
    </div>
    <div class="input-group">
        <label>Nama Sopir</label>
        <input type="text" id="in_sopir" class="kse-input" placeholder="Nama Sopir">
    </div>
    <div class="input-group">
        <label>Penerima</label>
        <input type="text" id="in_penerima" class="kse-input" placeholder="Nama Penerima">
    </div>
    <div class="input-group">
        <label>Admin</label>
        <input type="text" id="in_admin" class="kse-input" placeholder="Nama Admin">
    </div>

    <div class="button-group">
        <button class="btn-save" onclick="updatePreview(); saveData();">Update & Simpan</button>
        <button class="btn-pdf" onclick="downloadPDF()">Download PDF</button>
        <button class="btn-reset" onclick="resetForm()">Reset Form</button>
    </div>

    <div id="surat-jalan-render">
        <div class="preview-header">
            <h3>SURAT JALAN PENGIRIMAN</h3>
            <p>No: <span id="p_nosj">..........</span></p>
        </div>
        <div class="preview-content">
            <p>Kepada Yth, <br><span id="f_penerima">................</span></p>
            <p>Telah diterima barang dengan rincian berikut:</p>
            <p>Sopir: <span id="f_sopir">................</span></p>
            <p>Admin: <span id="f_admin">................</span></p>
        </div>
        <div id="qrcode"></div>
    </div>
</div>

<script>
    // Inisialisasi QR Code
    const qrcode = new QRCode(document.getElementById("qrcode"), {
        width: 128,
        height: 128
    });

    // Load data saat halaman dibuka
    window.onload = loadSavedData;

    function updatePreview() {
        const nosj = document.getElementById('in_nosj').value || "..........";
        const pt = document.getElementById('in_pt').value || "..........";
        const qty = document.getElementById('in_qty').value || "..........";
        const nopol = document.getElementById('in_nopol').value || "..........";

        // Mapping sederhana (jika id input dan id preview cocok)
        const mapping = {
            'in_nosj': 'p_nosj'
        };

        for (let id in mapping) { 
            if(document.getElementById(id)) document.getElementById(mapping[id]).innerText = document.getElementById(id).value; 
        }

        // Update teks dengan format BOLD pada penerima/tujuan
        document.getElementById('f_penerima').innerHTML = `<b>${document.getElementById('in_pt').value || "................"}</b>`;
        document.getElementById('f_sopir').innerText = document.getElementById('in_sopir').value || "................";
        document.getElementById('f_admin').innerText = document.getElementById('in_admin').value || "................";
        document.getElementById('p_nosj').innerText = nosj;

        // Update QR Code Content
        const qrContent = `NO SJ: ${nosj}\nTUJUAN: ${pt}\nQTY: ${qty}\nNOPOL: ${nopol}`;
        qrcode.clear();
        qrcode.makeCode(qrContent);
    }

    function saveData() {
        const data = {};
        document.querySelectorAll('.kse-input').forEach(input => { data[input.id] = input.value; });
        localStorage.setItem('kse_v3_data', JSON.stringify(data));
    }

    function loadSavedData() {
        const saved = localStorage.getItem('kse_v3_data');
        if (saved) {
            const data = JSON.parse(saved);
            Object.keys(data).forEach(id => { 
                if (document.getElementById(id)) {
                    document.getElementById(id).value = data[id];
                }
            });
            updatePreview(); // Jalankan preview setelah load
        }
    }

    function downloadPDF() {
        const element = document.getElementById('surat-jalan-render');
        const nosj = document.getElementById('p_nosj').innerText.replace(/\//g,'-');
        const namaPT = (document.getElementById('in_pt').value || "TanpaNama").trim().replace(/[/\\?%*:|"<>]/g, '-');
        const finalFileName = `SJ_${nosj}_${namaPT}.pdf`;

        const opt = {
            margin: 10,
            filename: finalFileName,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 2, useCORS: true, letterRendering: true },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function resetForm() { 
        if(confirm("Hapus semua data entry?")) { 
            localStorage.removeItem('kse_v3_data'); 
            location.reload(); 
        } 
    }
</script>

</body>
</html>

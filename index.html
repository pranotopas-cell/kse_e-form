<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem PT. KSE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .bg-hijau-tua { background-color: #064e3b; }
        .bg-tosca { background-color: #0d9488; }
        @media print {
            .no-print { display: none; }
            .print-only { display: block !important; }
            body { background: white; }
            .print-card { shadow: none; border: 1px solid #ccc; }
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-hijau-tua text-white p-4 shadow-xl no-print">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4 text-left w-full md:w-auto">
                <img id="logo-pt" src="" class="h-12 w-12 bg-white rounded p-1">
                <h1 id="nama-pt" class="text-xl font-bold uppercase tracking-widest">PT. KSE</h1>
            </div>
            <div class="flex bg-tosca rounded-full p-1 text-sm">
                <button onclick="switchTab('list')" class="px-4 py-2 hover:bg-hijau-tua rounded-full">Lihat Data</button>
                <button onclick="switchTab('input')" class="px-4 py-2 hover:bg-hijau-tua rounded-full">Input Baru</button>
            </div>
        </div>
    </nav>

    <main class="container mx-auto mt-8 p-4">
        
        <section id="sec-input" class="hidden no-print max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl border-t-4 border-tosca">
            <h2 class="text-2xl font-bold text-hijau-tua mb-6">Input Penawaran Baru</h2>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold uppercase">Nama Customer</label>
                <input id="in-customer" type="text" class="w-full p-2 border rounded border-teal-200"></div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold uppercase">Jenis BBM</label>
                    <input id="in-bbm" type="text" placeholder="Bio Solar" class="w-full p-2 border rounded border-teal-200"></div>
                    <div><label class="block text-xs font-bold uppercase">Volume (Liter)</label>
                    <input id="in-vol" type="number" class="w-full p-2 border rounded border-teal-200"></div>
                </div>
                
                <div><label class="block text-xs font-bold uppercase">Harga Per Liter</label>
                <input id="in-harga" type="number" class="w-full p-2 border rounded border-teal-200"></div>
                
                <button onclick="simpanData()" id="btn-simpan" class="w-full bg-tosca text-white font-bold py-3 rounded-xl hover:bg-hijau-tua">SIMPAN DATA</button>
            </div>
        </section>

        <section id="sec-list" class="no-print bg-white rounded-2xl shadow-2xl overflow-hidden border border-teal-100">
            <div class="bg-tosca p-4 flex justify-between">
                <h2 class="text-white font-bold uppercase italic">Data Penawaran</h2>
                <span id="load-status" class="text-xs text-white animate-pulse">Memuat...</span>
            </div>
            <div class="overflow-x-auto p-4">
                <table class="w-full text-left">
                    <thead class="bg-teal-50 text-hijau-tua">
                        <tr>
                            <th class="p-4 text-xs">No. Dokumen</th>
                            <th class="p-4 text-xs">Customer</th>
                            <th class="p-4 text-xs text-right">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </section>

        <div id="print-area" class="hidden print-only p-10 bg-white">
            <div class="flex justify-between border-b-4 border-hijau-tua pb-4 mb-6">
                <img id="print-logo" src="" class="h-20 w-20 object-contain">
                <div class="text-right text-xs">
                    <h1 id="print-nama-pt" class="text-xl font-bold"></h1>
                    <p id="print-alamat"></p>
                    <p id="print-kontak"></p>
                </div>
            </div>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold underline uppercase">Penawaran Harga BBM</h2>
                <p id="print-nomor" class="font-mono font-bold text-lg"></p>
            </div>
            <div class="mb-10">
                <p>Kepada Yth,</p>
                <p id="print-customer" class="font-bold text-lg uppercase"></p>
                <p>Di Tempat</p>
            </div>
            <table class="w-full border-collapse border border-black mb-10">
                <thead><tr class="bg-gray-100"><th class="border border-black p-2">Keterangan</th><th class="border border-black p-2">Volume</th><th class="border border-black p-2">Total</th></tr></thead>
                <tbody><tr><td id="print-desc" class="border border-black p-4"></td><td id="print-vol" class="border border-black p-4 text-center"></td><td id="print-total" class="border border-black p-4 text-right font-bold"></td></tr></tbody>
            </table>
            <div class="flex justify-end"><div class="text-center w-64"><p id="print-tgl"></p><br><br><br><p class="font-bold underline">Management PT. KSE</p></div></div>
        </div>

    </main>

    <script>
        
// -- KONFIGURASI --
const SUPABASE_URL = 'https://peumfitbkcaluhkvqjgl.supabase.co'; 
 const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBldW1maXRia2NhbHVoa3ZxamdsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2OTkyMDYsImV4cCI6MjA4NzI3NTIwNn0.5wGsdYOyiuiu01tas7g5vH5NOghF0-nF6bBJmQsFyO4';
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentDoc = 'penawaran_harga';
let profilData = {};

// 1. Fungsi Start Awal
async function init() {
    try {
        let { data } = await _supabase.from('perusahaan').select('*').limit(1).single();
        if(data) {
            profilData = data;
            document.getElementById('nama-pt').innerText = data.nama_bisnis;
            document.getElementById('logo-pt').src = data.logo_utama_url || 'https://via.placeholder.com/50';
        }
        switchDoc('penawaran_harga'); // Default buka penawaran
    } catch (e) { console.error("Gagal koneksi:", e); }
}

// 2. Ganti Menu Dokumen
function switchDoc(doc) {
    currentDoc = doc;
    // Ubah warna tombol menu
    document.querySelectorAll('.menu-btn').forEach(b => {
        b.classList.remove('bg-tosca', 'shadow-lg');
        if(b.id === 'btn-' + doc) b.classList.add('bg-tosca', 'shadow-lg');
    });
    
    document.getElementById('title-list').innerText = "DATA " + doc.toUpperCase();
    switchView('list');
    loadTable();
}

// 3. Ganti Tampilan (Lihat / Baru)
function switchView(view) {
    document.getElementById('sec-list').classList.toggle('hidden', view !== 'list');
    document.getElementById('sec-input').classList.toggle('hidden', view !== 'input');
    
    document.getElementById('view-list').classList.toggle('bg-hijau-tua', view === 'list');
    document.getElementById('view-input').classList.toggle('bg-hijau-tua', view === 'input');
    
    if(view === 'input') renderForm();
}

// 4. Render Form sesuai tabel
function renderForm() {
    const container = document.getElementById('form-fields');
    // Default form yang paling sering dipake
    container.innerHTML = `
        <div>
            <label class="block text-[10px] font-black uppercase">Nama Pelanggan / Supplier</label>
            <input id="f_nama" type="text" class="w-full p-3 border-2 rounded-xl border-teal-50 outline-none focus:border-tosca">
        </div>
        <div>
            <label class="block text-[10px] font-black uppercase">Keterangan / Deskripsi</label>
            <textarea id="f_catatan" class="w-full p-3 border-2 rounded-xl border-teal-50 outline-none focus:border-tosca"></textarea>
        </div>
    `;
}

// 5. Ambil Data dari Supabase (ANTI LEMOT)
async function loadTable() {
    document.getElementById('load-status').style.display = 'block';
    
    // Tarik data tipis-tipis aja biar cepet
    let { data, error } = await _supabase.from(currentDoc).select('*').order('created_at', {ascending:false}).limit(20);
    
    const body = document.getElementById('table-body');
    body.innerHTML = '';
    
    if (data) {
        data.forEach(item => {
            // Ambil nomor dokumen secara pintar
            const no = item.nomor_penawaran || item.nomor_po || item.nomor_sj || item.nomor_invoice || 'NO-NUMBER';
            const nama = item.pelanggan_nama || item.supplier_nama || item.penerima_nama || 'Umum';
            
            body.innerHTML += `
                <tr class="border-b border-teal-50 hover:bg-gray-50">
                    <td class="p-4 font-bold text-tosca">${no}</td>
                    <td class="p-4 uppercase text-gray-700 font-semibold">${nama}</td>
                    <td class="p-4 text-gray-400 text-xs">${new Date(item.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-right">
                        <button onclick="cetak('${item.id}')" class="bg-hijau-tua text-white px-3 py-1 rounded text-[10px]">CETAK</button>
                    </td>
                </tr>`;
        });
    }
    document.getElementById('load-status').style.display = 'none';
}

// 6. Simpan Data (Penting: Nama kolom harus pas sama SQL!)
async function simpanData() {
    const btn = document.getElementById('btn-simpan');
    btn.disabled = true;
    btn.innerText = "MENYIMPAN...";

    const namaValue = document.getElementById('f_nama').value;
    const catatanValue = document.getElementById('f_catatan').value;

    // Mapping kolom SQL
    let payload = {};
    if(currentDoc === 'penawaran_harga') payload = { pelanggan_nama: namaValue, catatan: catatanValue };
    else if(currentDoc === 'purchase_order') payload = { supplier_nama: namaValue };
    else if(currentDoc === 'surat_jalan') payload = { penerima_nama: namaValue };
    else if(currentDoc === 'invoice') payload = { metode_pembayaran: catatanValue };

    const { error } = await _supabase.from(currentDoc).insert([payload]);

    if(error) {
        alert("Error: " + error.message);
    } else {
        alert("Berhasil!");
        switchView('list');
        loadTable();
    }
    btn.disabled = false;
    btn.innerText = "SIMPAN DATA";
}

init();
       
    </script>
</body>
</html>

